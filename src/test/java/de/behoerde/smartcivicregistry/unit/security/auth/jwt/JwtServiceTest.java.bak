package de.behoerde.smartcivicregistry.unit.security.auth.jwt;  // Paket korrigieren

import de.behoerde.smartcivicregistry.security.jwt.JwtProperties;
import de.behoerde.smartcivicregistry.security.jwt.JwtService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
class JwtServiceTest {
    
    @Mock
    private JwtProperties jwtProperties;
    
    @InjectMocks
    private JwtService jwtService;
    
    @BeforeEach
    void setUp() {
        when(jwtProperties.getSecretKey()).thenReturn("VGhpc0lzQVNlY3VyZVNlY3JldEtleUZvclJ3dFRva2VuR2VuZXJhdGlvbjIwMjQh");
        when(jwtProperties.getExpiration()).thenReturn(86400000L);
    }
    
    @Test
    void generateToken_ShouldReturnValidToken() {
        // Given
        var userDetails = org.springframework.security.core.userdetails.User
                .withUsername("test@example.com")
                .password("password")
                .authorities("ROLE_USER")
                .build();
        
        // When
        String token = jwtService.generateToken(userDetails);
        
        // Then
        assertThat(token).isNotNull();
        assertThat(token).isNotEmpty();
    }
    
    @Test
    void extractUsername_ShouldReturnUsernameFromToken() {
        // Given
        var userDetails = org.springframework.security.core.userdetails.User
                .withUsername("test@example.com")
                .password("password")
                .authorities("ROLE_USER")
                .build();
        
        String token = jwtService.generateToken(userDetails);
        
        // When
        String username = jwtService.extractUsername(token);
        
        // Then
        assertThat(username).isEqualTo("test@example.com");
    }
    
    @Test
    void isTokenValid_ShouldReturnTrueForValidToken() {
        // Given
        var userDetails = org.springframework.security.core.userdetails.User
                .withUsername("test@example.com")
                .password("password")
                .authorities("ROLE_USER")
                .build();
        
        String token = jwtService.generateToken(userDetails);
        
        // When
        boolean isValid = jwtService.isTokenValid(token, userDetails);
        
        // Then
        assertThat(isValid).isTrue();
    }
}
